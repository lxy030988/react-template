# HTTP/3 Server (QUIC on port 8443)
server {
    listen 8443 quic reuseport;
    listen 8443 ssl http2;
    
    server_name localhost;
    
    ssl_certificate /opt/homebrew/etc/nginx/ssl/localhost.crt;
    ssl_certificate_key /opt/homebrew/etc/nginx/ssl/localhost.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # 通告HTTP/3支持
    add_header Alt-Svc 'h3=":8443"; ma=86400';
    add_header X-Protocol $server_protocol always;
    
    root /Users/lxy/Desktop/lxy030988/react-template/dist;
    index index.html;
    
    # 启用ETag协商缓存
    etag on;
    if_modified_since exact;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    
    # HTML - 不缓存，每次协商
    location ~* \.html$ {
        add_header Cache-Control "no-cache, must-revalidate";
        add_header X-Content-Type-Options "nosniff";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        try_files $uri /index.html;
    }
    
    # JS/CSS - 强缓存1年
    location ~* \.(js|css)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        access_log off;
    }
    
    # 图片 - 强缓存30天
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        add_header Cache-Control "public, max-age=2592000";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        access_log off;
    }
    
    # 字体 - 强缓存1年
    location ~* \.(woff|woff2|ttf|eot)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        access_log off;
    }
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# HTTP/2 Server (Standard HTTPS on port 443)
server {
    listen 443 ssl http2;
    
    server_name localhost;
    
    ssl_certificate /opt/homebrew/etc/nginx/ssl/localhost.crt;
    ssl_certificate_key /opt/homebrew/etc/nginx/ssl/localhost.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    
    # 建议升级到HTTP/3
    add_header Alt-Svc 'h3=":8443"; ma=86400';
    add_header X-Protocol $server_protocol always;
    
    root /Users/lxy/Desktop/lxy030988/react-template/dist;
    index index.html;
    
    # 启用ETag协商缓存
    etag on;
    if_modified_since exact;
    
    # Gzip压缩
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss application/rss+xml font/truetype font/opentype application/vnd.ms-fontobject image/svg+xml;
    
    # HTML - 不缓存，每次协商
    location ~* \.html$ {
        add_header Cache-Control "no-cache, must-revalidate";
        add_header X-Content-Type-Options "nosniff";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        try_files $uri /index.html;
    }
    
    # JS/CSS - 强缓存1年
    location ~* \.(js|css)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        access_log off;
    }
    
    # 图片 - 强缓存30天
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp)$ {
        add_header Cache-Control "public, max-age=2592000";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        access_log off;
    }
    
    # 字体 - 强缓存1年
    location ~* \.(woff|woff2|ttf|eot)$ {
        add_header Cache-Control "public, max-age=31536000, immutable";
        add_header Alt-Svc 'h3=":8443"; ma=86400';
        add_header X-Protocol $server_protocol always;
        access_log off;
    }
    
    # SPA路由支持
    location / {
        try_files $uri $uri/ /index.html;
    }
}

# HTTP to HTTPS重定向
server {
    listen 80;
    server_name localhost;
    return 301 https://$server_name$request_uri;
}
